
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentinelID - Real Anomaly Detection</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Segoe UI; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 900px; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .content { padding: 30px; max-height: 80vh; overflow-y: auto; }
        .auth-container { display: none; }
        .auth-container.active { display: block; }
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .auth-tabs { display: flex; gap: 10px; border-bottom: 2px solid #eee; margin-bottom: 30px; }
        .tab-btn { background: none; border: none; padding: 12px 20px; cursor: pointer; color: #999; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; }
        input:focus, textarea:focus { outline: none; border-color: #667eea; }
        button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        button:hover { background: #5568d3; }
        .welcome-banner { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .metric-card { background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea; }
        .metric-label { font-size: 12px; color: #999; text-transform: uppercase; }
        .metric-value { font-size: 32px; font-weight: bold; color: #333; }
        .confidence-bar { background: #eee; height: 20px; border-radius: 6px; overflow: hidden; margin: 20px 0; }
        .confidence-fill { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; font-weight: bold; }
        .input-area { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .input-area textarea { min-height: 100px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .stat { background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: #999; }
        .events-log { margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 12px; max-height: 200px; overflow-y: auto; }
        .event { padding: 10px; margin-bottom: 10px; background: white; border-left: 4px solid #667eea; border-radius: 4px; font-size: 12px; }
        .logout-btn { background: #ff6b6b; margin-top: 20px; }
        .message { padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .warning { color: #ff6b6b; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è SentinelID</h1>
            <p>Real-Time Behavioral Biometric Authentication</p>
        </div>
        <div class="content">
            <!-- AUTH SECTION -->
            <div class="auth-container active">
                <div class="auth-tabs">
                    <button class="tab-btn active" data-tab="login">Login</button>
                    <button class="tab-btn" data-tab="register">Register</button>
                </div>
                <div id="message"></div>
                
                <div id="login" class="auth-form active">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="login-username" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" placeholder="Enter password">
                    </div>
                    <button onclick="login()">Login</button>
                </div>
                
                <div id="register" class="auth-form">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="register-username">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="register-email">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="register-password">
                    </div>
                    <button onclick="register()">Create Account</button>
                </div>
            </div>
            
            <!-- DASHBOARD SECTION -->
            <div class="dashboard">
                <div class="welcome-banner">
                    <h2>Welcome, <span id="username-display">User</span>! üëã</h2>
                    <p>Real-Time Behavioral Anomaly Detection Active</p>
                </div>
                
                <div class="metrics">
                    <div class="metric-card">
                        <div class="metric-label">Session Confidence</div>
                        <div class="metric-value" id="confidence">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Status</div>
                        <div class="metric-value" id="status-display">Initializing...</div>
                    </div>
                </div>
                
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidence-bar" style="width: 50%;">Collecting Data...</div>
                </div>
                
                <div class="input-area">
                    <label>üí¨ Type naturally to establish baseline behavior...</label>
                    <textarea id="input-text" placeholder="Type at your natural speed and rhythm..."></textarea>
                    
                    <div class="stats-grid">
                        <div class="stat">
                            <div class="stat-value" id="keystroke-count">0</div>
                            <div class="stat-label">üî§ Keystrokes</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="typing-speed">0</div>
                            <div class="stat-label">‚ö° WPM</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="dwell-time">0</div>
                            <div class="stat-label">üìä Dwell (ms)</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="real-confidence">--</div>
                            <div class="stat-label">üõ°Ô∏è Confidence</div>
                        </div>
                    </div>
                </div>
                
                <div class="events-log">
                    <h3>üìù Anomaly Monitoring Log</h3>
                    <div id="events-container">
                        <div class="event"><span style="color: #667eea; font-weight: bold;">[Started]</span> Behavioral baseline collection active...</div>
                    </div>
                </div>
                
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000';
        let token = localStorage.getItem('token');
        let keystrokeCount = 0;
        let typingStartTime = null;
        let keyTimings = [];
        let baselineCollected = false;
        let baselineFeatures = [];
        
        if (token) showDashboard();
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });
        
        async function register() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!username || !email || !password) {
                showMessage('Fill all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ Registration successful! Please login.', 'success');
                    setTimeout(() => document.querySelector('[data-tab="login"]').click(), 1500);
                } else {
                    showMessage(data.message || 'Failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                showMessage('Fill all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                
                if (response.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    localStorage.setItem('username', username);
                    showMessage('‚úÖ Login successful!', 'success');
                    setTimeout(showDashboard, 1000);
                } else {
                    showMessage(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        function logout() {
            token = null;
            localStorage.clear();
            keystrokeCount = 0;
            baselineCollected = false;
            baselineFeatures = [];
            document.querySelector('.auth-container').classList.add('active');
            document.querySelector('.dashboard').classList.remove('active');
        }
        
        function showDashboard() {
            document.querySelector('.auth-container').classList.remove('active');
            document.querySelector('.dashboard').classList.add('active');
            document.getElementById('username-display').textContent = localStorage.getItem('username');
            setupBehavioralTracking();
        }
        
        function showMessage(msg, type) {
            const el = document.getElementById('message');
            el.innerHTML = `<div class="message ${type}">${msg}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }
        
        function extractFeatures() {
            // Extract: [wpm, dwell_avg, dwell_variance]
            const keyCount = keystrokeCount;
            const timeElapsed = (Date.now() - typingStartTime) / 1000 / 60; // minutes
            const wpm = timeElapsed > 0 ? Math.round((keyCount / 5) / timeElapsed) : 0;
            
            const dwellTimes = keyTimings.map(k => k.dwell || 0);
            const dwellAvg = dwellTimes.length > 0 ? dwellTimes.reduce((a, b) => a + b) / dwellTimes.length : 0;
            const dwellVar = dwellTimes.length > 0 ? Math.sqrt(dwellTimes.reduce((a, b) => a + (b - dwellAvg) ** 2) / dwellTimes.length) : 0;
            
            return [wpm, dwellAvg, dwellVar];
        }
        
        async function checkAnomaly() {
            if (!token || keystrokeCount < 5) return;
            
            const features = extractFeatures();
            
            try {
                const res = await fetch(`${API_BASE}/api/anomaly/check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ features })
                });
                
                const data = await res.json();
                const confidence = data.confidence || 85;
                
                // Update UI
                document.getElementById('confidence').textContent = Math.round(confidence) + '%';
                document.getElementById('real-confidence').textContent = Math.round(confidence) + '%';
                document.getElementById('confidence-bar').style.width = confidence + '%';
                document.getElementById('confidence-bar').textContent = Math.round(confidence) + '%';
                
                // Status indicator
                let status = '';
                if (confidence >= 80) status = '‚úÖ Safe';
                else if (confidence >= 50) status = '‚ö†Ô∏è Watch';
                else status = 'üö® Alert';
                
                document.getElementById('status-display').textContent = status;
                
                // Collect baseline data (first 30 readings)
                if (baselineFeatures.length < 30) {
                    baselineFeatures.push(features);
                    addEvent(`üìä Baseline [${baselineFeatures.length}/30]: Confidence ${Math.round(confidence)}%`);
                    
                    if (baselineFeatures.length === 30) {
                        trainModel();
                    }
                }
            } catch (error) {
                console.error('Anomaly check error:', error);
            }
        }
        
        async function trainModel() {
            try {
                const res = await fetch(`${API_BASE}/api/behavioral/train_baseline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ features: baselineFeatures })
                });
                
                const data = await res.json();
                if (data.status === 'ok') {
                    baselineCollected = true;
                    addEvent(`<span class="success">üéì Model trained!</span> Now detecting anomalies...`);
                } else {
                    addEvent(`<span class="warning">Training failed: ${data.msg}</span>`);
                }
            } catch (error) {
                console.error('Training error:', error);
            }
        }
        
        function addEvent(msg) {
            const container = document.getElementById('events-container');
            const time = new Date().toLocaleTimeString();
            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            eventEl.innerHTML = `<span style="color: #667eea; font-weight: bold;">[${time}]</span> ${msg}`;
            container.appendChild(eventEl);
            container.scrollTop = container.scrollHeight;
        }
        
        function setupBehavioralTracking() {
            const input = document.getElementById('input-text');
            let lastKeyTime = Date.now();
            
            input.addEventListener('keydown', function() {
                if (typingStartTime === null) {
                    typingStartTime = Date.now();
                    addEvent('‚å®Ô∏è Typing started - collecting baseline...');
                }
                
                keystrokeCount++;
                document.getElementById('keystroke-count').textContent = keystrokeCount;
                
                // Calculate WPM
                const elapsed = (Date.now() - typingStartTime) / 1000 / 60;
                const wpm = elapsed > 0 ? Math.round((keystrokeCount / 5) / elapsed) : 0;
                document.getElementById('typing-speed').textContent = wpm;
            });
            
            input.addEventListener('keyup', function() {
                const now = Date.now();
                const dwellTime = now - lastKeyTime;
                lastKeyTime = now;
                
                keyTimings.push({ dwell: dwellTime });
                if (keyTimings.length > 100) keyTimings.shift();
                
                const avgDwell = keyTimings.reduce((a, b) => a + b.dwell, 0) / keyTimings.length;
                document.getElementById('dwell-time').textContent = Math.round(avgDwell);
                
                // Check anomaly every keystroke (after 5 keys)
                if (keystrokeCount % 5 === 0) {
                    checkAnomaly();
                }
            });
        }
    </script>
</body>
</html>
